# 카카오톡 실시간 메시지 송수신 통합 에이전트 (v1.0)

본 프로젝트는 윈도우 OS 환경에서 카카오톡 PC 버전의 데이터를 실시간으로 수집(DB화)하고, 사용자 방해 없이 메시지를 전송하는 통합 관제 프로그램입니다. 단순 매크로를 넘어 **데이터 무결성**과 **사용자 경험(UX)**을 최우선으로 설계되었습니다.

---

## 1. 기술 연구 및 시도 이력 (Deep Research)

카카오톡의 폐쇄적인 보안 및 독자적인 렌더링 구조를 극복하기 위해 수행한 기술적 실험 기록입니다.

### [Research 01] UI 가상화 및 접근성 차단 분석
- **시도**: Microsoft UI Automation(UIA) 및 MSAA 표준 패턴을 이용한 직접 텍스트 추출.
- **발견**: `inspect.exe` 분석 결과, 카톡은 표준 컨트롤을 쓰지 않고 자체 그래픽 엔진(Direct2D)으로 글자를 직접 캔버스에 그림 (`IsTextPatternAvailable: False`).
- **결론**: 표준 접근성 API로는 텍스트 스트림 확보가 불가능함을 기술적으로 증명. (관련: `01_uia_msaa_failure_analysis.py`)

### [Research 02] 커널 메시지 주입 및 스레드 동기화 시도
- **시도**: `AttachThreadInput`으로 봇과 카톡의 입력 스레드를 결합하고 `WM_GETTEXT` 커널 신호 주입.
- **발견**: 창 제목(Caption) 획득에는 성공했으나, 내부 대화 상자는 외부 스레드의 데이터 요청을 거부하도록 설계됨 확인.
- **결론**: 시스템 표준 프로토콜을 우회하는 카톡의 강력한 보안 정책 확인. (관련: `02_kernel_api_failure_analysis.py`)

### [Research 03] 프로세스 식별 및 오탐지 해결
- **시도**: 제목이 같은 브라우저나 터미널 창을 카톡으로 오인하는 문제 해결.
- **해결**: 단순히 창 제목만 보지 않고, 핸들(HWND)의 소유 프로세스명(`KakaoTalk.exe`)을 2중 검증하여 타겟팅 정확도 100% 달성. (관련: `03_process_targeting_study.py`)

### [Research 04] 송신 이벤트 트리거 실패 분석
- **시도**: `WM_SETTEXT` 및 `SendInput`(하드웨어 타이핑)을 통한 백그라운드 전송.
- **발견**: 텍스트 주입은 성공하나 카톡 내부의 '입력 감지 이벤트'가 발생하지 않아 전송 버튼이 활성화되지 않음.
- **결론**: 단순 주입이 아닌 '붙여넣기(V)'와 'Enter' 이벤트를 조합한 최종 솔루션 도출. (관련: `04_send_message_failure_analysis.py`)

### [Research 05] 시스템 권한 격리(UIPI) 대응
- **분석**: 분석 도구(Inspect)에서는 보이나 파이썬 코드 접근이 차단되는 원인이 관리자 권한 프로세스 정보를 일반 권한이 읽지 못하는 **UIPI(User Interface Privilege Isolation)** 문제임을 진단.
- **해결**: 실행 환경 승격 및 스레드 입력 결합(AttachThreadInput) 기술을 통해 OS 레벨의 통신 권한 확보.

---

## 2. 핵심 엔지니어링 고민 및 해결 (Deliberations)

### ① 사용자 경험(UX) 최적화: "스텔스 컨트롤"
- **포커스 뺏기 및 타이핑 간섭**: 봇이 작동할 때 사용자의 작업이 중단되지 않도록 **유휴 시간 감지(Idle Time Detection)** 로직을 구현했습니다. 사용자가 3초 이상 입력을 멈췄을 때만 0.2초 이내로 복사 작업을 완료합니다.
- **유령 모드 (Ghost Mode)**: 창을 최소화하면 수집이 멈추는 문제를 해결하기 위해, 창을 물리적 화면 밖(-5000, -5000)으로 배치하여 사용자 시야와 마우스 동선에서 완전히 격리했습니다.
- **물리적 마우스 간섭 방지**: 마우스 커서를 직접 움직이면 사용자가 불편함을 느끼므로, `PostMessage` 기반의 **가상 클릭(Virtual Click)** 신호를 보내 마우스 튐 현상 없이 포커스를 획득합니다.
- **클립보드 데이터 보호**: 봇이 클립보드를 쓰기 직전 사용자의 기존 데이터를 백업하고, 작업 종료 후 즉시 복구하는 **매너 모드**를 구현하여 사용자의 데이터 유실을 차단했습니다.

### ② 데이터 무결성: "도배 대응 및 동기화 알고리즘"
- **ㅇㅇㅇ 도배 메시지 처리**: 카톡 시간 정보가 '분' 단위까지만 제공되어 발생하는 중복 판정 오류를 해결하기 위해, 단순 해시 체크가 아닌 **역방향 윈도우 매칭(Reverse Sliding Window Matching)** 알고리즘을 설계하여 도배 메시지를 누락 없이 수집합니다.
- **효율적인 대량 데이터 필터링**: 수만 줄의 대화 내역 중 **DB의 마지막 5~10줄 뭉치(Anchor)**를 현재 카톡창의 끝에서부터 역방향으로 스캔하여, 시스템 부하를 최소화하며 신규 데이터만 정밀 수집합니다.
- **장애 복구 (Fail-safe)**: 프로그램 강제 종료나 시스템 재시작 시, 매 수집 주기마다 DB 상태를 실시간 참조하는 **무상태(Stateless) 동기화**를 통해 꺼져있던 시간 동안의 메시지 유실을 자동 복구합니다.

### ③ 아키텍처 설계: "확장성 있는 MVC"
- 자바 개발자의 관점에서 **Controller - Service - Repository - Infrastructure** 계층을 엄격히 분리했습니다.
- **멀티스레딩**: 수신 루프를 백그라운드 스레드로 분리하여, 실시간 메시지 수집과 사용자의 실시간 CLI 채팅(송신)이 동시에 가능한 통합 환경을 구축했습니다.

---

## 3. 엔지니어로서의 의사결정 (Final Decision)

> 처음에는 UI Automation과 Memory 직접 접근을 시도했으나, 타겟 애플리케이션의 비표준 렌더링 방식과 보안 정책을 확인했습니다. 이에 따라 **데이터의 무결성(Integrity)**을 100% 보장하면서도 **사용자 경험(UX)**을 해치지 않는 **'클립보드 컨텍스트 백업/복원 알고리즘'**을 상상력을 발휘하여 최종 구현했습니다.

---

## 4. 프로젝트 구조 (Project Structure)
```text
PyProject/
├── kakao_main.py             # [Controller] 프로그램 실행 및 CLI 통합 관리
├── kakao_receive_service.py  # [Service] 수집/동기화/파싱 비즈니스 로직
├── kakao_send_service.py     # [Service] 메시지 전송 및 포커스 롤백 로직
├── kakao_repository.py       # [Repository] SQLAlchemy 기반 DB CRUD
├── models.py                 # [Entity] 데이터 스키마 정의
├── database_config.py        # [Config] DB 연결 및 세션 설정
├── window_utils.py           # [Infra] OS 핸들 및 시스템 유틸리티
└── research/                 # [Research] 단계별 기술 실험 및 분석 리포트
```

---

## 5. 실행 방법 (Quick Start)
1. 카카오톡 채팅방을 별도 창으로 분리 실행 (대상: "지혁")
2. 의존성 설치: `pip install pywin32 pyperclip psutil sqlalchemy`
3. 프로그램 실행: `python PyProject/kakao_main.py`
4. 수집 데이터 확인: `kakao_data.db` (SQLite)

---

## 6. 추후 필요시 고도화 및 확장 계획 (Future Work)

현재의 우회 방식을 넘어, 시스템 자원을 더욱 효율적으로 관리하고 보안 성벽을 정면 돌파하기 위한 고도화 계획입니다.

### ① 메모리 포인터 직접 추적 (Direct Memory Access)
- **계획**: 카카오톡 프로세스의 실제 RAM 영역을 스캔하여 대화 리스트가 저장되는 **메모리 주소(Pointer)와 오프셋(Offset)**을 추출하여 데이터를 직접 읽기.
- **한계점**: 프로그램 업데이트 시 메모리 주소가 변경되어 **유지보수 비용이 높으며**, 카톡이 메모리 값을 난독화(Obfuscation)할 경우 해독이 어려움.

### ② DLL Injection 및 내부 함수 후킹 (Hooking)
- **계획**: 카톡 프로세스 내부에 커스텀 DLL을 삽입하여, 메시지 수신 시 호출되는 **내부 이벤트 핸들러**를 가로챔.
- **한계점**: 카톡 자체 보안 엔진이나 백심에 의해 **'악성 행위'로 간주되어 계정 정지나 프로그램 차단 리스크**가 매우 큼.

### ③ 패킷 분석 및 암호화 프로토콜 해독 (Network Sniffing)
- **계획**: 카톡 고유의 **LOCO 프로토콜** 암호화 체계를 분석하여 네트워크 레이어에서 패킷 단위로 수집.
- **한계점**: 카톡의 **강력한 종단간 암호화(E2EE)**와 독자적 프로토콜 업데이트 시 분석이 원점으로 돌아갈 위험이 크며, HTTPS 복호화의 높은 장벽 존재.

### ④ 서비스 확장성 (Java 연동)
- **계획**: 현재의 Python 수집기를 에이전트화하고, **Spring Boot** 서버와 REST API/gRPC로 연동하여 엔터프라이즈급 메시지 관리 시스템 구축.
- **기대 효과**: 데이터의 시각화, 통계 분석, 타 시스템(ERP 등)과의 연동성 확보.
### ⑤ OCR 기반 채팅방 자동 탐색 및 오픈
- **계획**: 메인 창의 채팅 목록을 이미지 스캔하여 텍스트를 추출한 뒤, 특정 방 이름을 검색하여 자동으로 더블클릭하는 기능 구현.
- **이유**: 텍스트 속성이 차단된 **리스트 컨트롤의 한계** 를 이미지 분석 기술로 극복하기 위함.
